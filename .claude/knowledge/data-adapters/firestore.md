# Firestore Data Adapter

How to sync user data from Firebase/Firestore projects.

## Detection

Project uses Firestore if ANY of these are true:
- `firebase.json` exists in project root
- `firestore.rules` exists
- `package.json` contains `firebase` or `firebase-admin`
- `.firebaserc` exists

## Schema Discovery

### Step 1: Find user-related collections

Search in codebase:
```bash
# Find collection references
grep -r "collection\(['\"]" --include="*.ts" --include="*.js" | head -30
```

Common patterns:
- `collection('users')` - main user data
- `collection('profiles')` - user profiles
- `collection('accounts')` - user accounts
- Collections with `userId` field - user-owned data

### Step 2: Identify key fields

From Firestore rules or code, identify:
- **User ID source**: Usually Firebase Auth UID
- **Email field**: Often in Auth, sometimes duplicated in Firestore
- **Timestamp fields**: `createdAt`, `updatedAt`, `lastLoginAt`
- **Activity fields**: counters, status, tier

### Step 3: Map to infrastructure.json

```json
{
  "database": {
    "type": "firestore",
    "projectId": "my-project",
    "collections": {
      "users": {
        "idField": "uid",
        "fields": ["email", "createdAt", "tier", "displayName"]
      },
      "content": {
        "userIdField": "userId",
        "fields": ["createdAt", "type", "status"]
      }
    }
  }
}
```

## Sync Script Template

**Important:** This script uses Firebase Admin SDK. User needs `gcloud auth application-default login`.

```python
#!/usr/bin/env python3
"""
Firestore User Sync Script
Generated by Product OS

Prerequisites:
  gcloud auth application-default login
  gcloud config set project {{PROJECT_ID}}

Usage:
  python3 sync_users.py
  python3 sync_users.py --since=2026-01-12
"""

import json
import sys
import os
from datetime import datetime

# Parse arguments
since_date = None
for arg in sys.argv[1:]:
    if arg.startswith('--since='):
        since_date = datetime.fromisoformat(arg.split('=')[1])

# Firebase Admin SDK setup
try:
    import firebase_admin
    from firebase_admin import credentials, auth, firestore
except ImportError:
    print("ERROR: firebase-admin not installed", file=sys.stderr)
    print("Run: pip install firebase-admin", file=sys.stderr)
    sys.exit(1)

# Initialize Firebase
if not firebase_admin._apps:
    firebase_admin.initialize_app()

db = firestore.client()
firebase_auth = auth

def get_users():
    """Get all users from Firebase Auth with Firestore data."""
    users = []

    # Get users from Firebase Auth
    page = firebase_auth.list_users()
    while page:
        for user in page.users:
            # Filter by date if specified
            created = datetime.fromisoformat(user.user_metadata.creation_timestamp.replace('Z', '+00:00').replace('+00:00', ''))
            if since_date and created < since_date:
                continue

            user_data = {
                'id': user.uid,
                'email': user.email,
                'created_at': user.user_metadata.creation_timestamp,
                'last_sign_in': user.user_metadata.last_sign_in_timestamp,
                'metrics': {}
            }

            # Get additional data from Firestore {{USERS_COLLECTION}}
            try:
                doc = db.collection('{{USERS_COLLECTION}}').document(user.uid).get()
                if doc.exists:
                    firestore_data = doc.to_dict()
                    # Add relevant metrics
                    for field in ['tier', 'plan', 'status', 'creditsUsed', 'generationsCount']:
                        if field in firestore_data:
                            user_data['metrics'][field] = firestore_data[field]
            except Exception as e:
                pass  # Firestore doc may not exist for all users

            # Get activity metrics from {{ACTIVITY_COLLECTION}}
            try:
                activity_docs = db.collection('{{ACTIVITY_COLLECTION}}')\
                    .where('userId', '==', user.uid)\
                    .limit(100)\
                    .get()
                user_data['metrics']['activity_count'] = len(activity_docs)
            except Exception:
                pass

            users.append(user_data)

        # Get next page
        page = page.get_next_page()

    return users

if __name__ == '__main__':
    users = get_users()
    print(json.dumps(users, indent=2, default=str))
```

## Template Variables

Replace these placeholders based on `infrastructure.json`:

| Variable | Description | Example |
|----------|-------------|---------|
| `{{PROJECT_ID}}` | Firebase project ID | `tonemark-prod` |
| `{{USERS_COLLECTION}}` | Main users collection | `users` |
| `{{ACTIVITY_COLLECTION}}` | User activity collection | `content` |

## Incremental Sync

Firebase Auth doesn't support filtering by creation date server-side.

**Strategy:**
1. Fetch all users from Auth (fast, ~1s for 1000 users)
2. Filter client-side by `creation_timestamp >= since_date`
3. Only query Firestore for filtered users

```python
# Filter users client-side
if since_date:
    users = [u for u in users if u.user_metadata.creation_timestamp >= since_date]
```

## Common Issues

### "Could not automatically determine credentials"

```bash
# Login to Google Cloud
gcloud auth application-default login

# Or use service account
export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json
```

### "Permission denied"

User needs Firebase Admin access. Options:
1. Use project owner account
2. Add IAM roles: `Firebase Admin`, `Cloud Datastore User`

### "firebase-admin not installed"

```bash
pip install firebase-admin
```

## Auto-discovered Metrics

When syncing, look for these patterns in Firestore documents:

**Counters:**
- `creditsUsed`, `creditsAllocated`
- `generationsCount`, `contentCount`
- `sessionsCount`, `loginCount`

**Status:**
- `tier` (free/pro/enterprise)
- `plan`, `subscription`
- `status` (active/inactive/churned)

**Timestamps:**
- `lastActiveAt`, `lastLoginAt`
- `firstContentAt`, `lastContentAt`
- `onboardingCompletedAt`

Save all discovered metrics to `metrics` JSON column in SQLite.
