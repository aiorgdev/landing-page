# Supabase Data Adapter

How to sync user data from Supabase projects.

## Detection

Project uses Supabase if ANY of these are true:
- `supabase/` directory exists
- `package.json` contains `@supabase/supabase-js`
- `.env` contains `SUPABASE_URL` or `NEXT_PUBLIC_SUPABASE_URL`
- `supabase/config.toml` exists

## Schema Discovery

### Step 1: Read migrations

```bash
# Find all migration files
ls supabase/migrations/*.sql 2>/dev/null

# Read migration content
cat supabase/migrations/*.sql
```

Look for:
- `CREATE TABLE` statements
- Column definitions with types
- Foreign key relationships
- RLS policies mentioning `auth.uid()`

### Step 2: Identify user tables

Common patterns:
- `auth.users` - Supabase built-in auth table
- `public.profiles` - User profiles (linked to auth.users)
- `public.users` - Custom users table
- Tables with `user_id UUID REFERENCES auth.users(id)`

### Step 3: Map to infrastructure.json

```json
{
  "database": {
    "type": "supabase",
    "url": "https://xxx.supabase.co",
    "tables": {
      "profiles": {
        "idField": "id",
        "userIdField": "id",
        "fields": ["email", "created_at", "full_name", "avatar_url"]
      },
      "subscriptions": {
        "userIdField": "user_id",
        "fields": ["status", "plan", "current_period_end"]
      }
    }
  }
}
```

## Sync Script Template

**Important:** Requires `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` in `.env`.

```python
#!/usr/bin/env python3
"""
Supabase User Sync Script
Generated by Product OS

Prerequisites:
  Set in .env or environment:
    SUPABASE_URL=https://xxx.supabase.co
    SUPABASE_SERVICE_ROLE_KEY=eyJ...

Usage:
  python3 sync_users.py
  python3 sync_users.py --since=2026-01-12
"""

import json
import sys
import os
from datetime import datetime
from urllib.request import Request, urlopen
from urllib.error import HTTPError

# Parse arguments
since_date = None
for arg in sys.argv[1:]:
    if arg.startswith('--since='):
        since_date = arg.split('=')[1]

# Load environment
def load_env():
    """Load .env file manually (no dotenv dependency)."""
    env_paths = ['.env', '.env.local', '../.env.local']
    for env_path in env_paths:
        if os.path.exists(env_path):
            with open(env_path) as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#') and '=' in line:
                        key, value = line.split('=', 1)
                        os.environ.setdefault(key.strip(), value.strip())

load_env()

SUPABASE_URL = os.environ.get('SUPABASE_URL') or os.environ.get('NEXT_PUBLIC_SUPABASE_URL')
SUPABASE_KEY = os.environ.get('SUPABASE_SERVICE_ROLE_KEY')

if not SUPABASE_URL or not SUPABASE_KEY:
    print("ERROR: Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY", file=sys.stderr)
    sys.exit(1)

def supabase_request(endpoint, method='GET', data=None):
    """Make request to Supabase REST API."""
    url = f"{SUPABASE_URL}{endpoint}"
    headers = {
        'apikey': SUPABASE_KEY,
        'Authorization': f'Bearer {SUPABASE_KEY}',
        'Content-Type': 'application/json'
    }

    req = Request(url, headers=headers, method=method)
    if data:
        req.data = json.dumps(data).encode()

    try:
        with urlopen(req) as response:
            return json.loads(response.read())
    except HTTPError as e:
        print(f"ERROR: {e.code} - {e.read().decode()}", file=sys.stderr)
        return None

def get_auth_users():
    """Get users from Supabase Auth."""
    # Use admin API to list users
    result = supabase_request('/auth/v1/admin/users')
    if not result:
        return []
    return result.get('users', [])

def get_profiles():
    """Get user profiles from {{PROFILES_TABLE}}."""
    endpoint = '/rest/v1/{{PROFILES_TABLE}}?select=*'
    if since_date:
        endpoint += f'&created_at=gte.{since_date}'
    return supabase_request(endpoint) or []

def get_user_metrics(user_id):
    """Get additional metrics for a user."""
    metrics = {}

    # Get from {{METRICS_TABLE}} if exists
    result = supabase_request(f'/rest/v1/{{METRICS_TABLE}}?user_id=eq.{user_id}&select=*')
    if result and len(result) > 0:
        metrics.update(result[0])

    # Count user's content/activity
    count_result = supabase_request(f'/rest/v1/{{ACTIVITY_TABLE}}?user_id=eq.{user_id}&select=count')
    if count_result:
        metrics['activity_count'] = count_result[0].get('count', 0) if count_result else 0

    return metrics

def get_users():
    """Get all users with profiles and metrics."""
    users = []

    # Get auth users
    auth_users = get_auth_users()

    # Get profiles for faster lookup
    profiles = {p['id']: p for p in get_profiles()}

    for auth_user in auth_users:
        user_id = auth_user['id']
        created_at = auth_user.get('created_at', '')

        # Filter by date if specified
        if since_date and created_at < since_date:
            continue

        profile = profiles.get(user_id, {})

        user_data = {
            'id': user_id,
            'email': auth_user.get('email'),
            'created_at': created_at,
            'last_sign_in': auth_user.get('last_sign_in_at'),
            'metrics': {}
        }

        # Add profile data
        for field in ['full_name', 'avatar_url', 'tier', 'plan', 'status']:
            if field in profile:
                user_data['metrics'][field] = profile[field]

        # Get additional metrics
        additional = get_user_metrics(user_id)
        user_data['metrics'].update(additional)

        users.append(user_data)

    return users

if __name__ == '__main__':
    users = get_users()
    print(json.dumps(users, indent=2, default=str))
```

## Template Variables

Replace these placeholders based on `infrastructure.json`:

| Variable | Description | Example |
|----------|-------------|---------|
| `{{PROFILES_TABLE}}` | User profiles table | `profiles` |
| `{{METRICS_TABLE}}` | User metrics/subscriptions | `subscriptions` |
| `{{ACTIVITY_TABLE}}` | User activity/content | `posts` |

## Incremental Sync

Supabase supports server-side filtering!

```python
# Filter by created_at
endpoint = f'/rest/v1/profiles?created_at=gte.{since_date}'

# Or by updated_at for changes
endpoint = f'/rest/v1/profiles?updated_at=gte.{since_date}'
```

This makes incremental sync efficient - no need to fetch all users.

## Common Issues

### "Missing SUPABASE_SERVICE_ROLE_KEY"

Service role key is required for admin operations (listing all users).
Find it in Supabase Dashboard → Settings → API → Service role key.

**Never expose this key client-side!**

### "Permission denied on auth.users"

The service role key should have access to auth admin API.
If issues persist, check Supabase project settings.

### "No users found in profiles"

Some projects don't use a profiles table. Options:
1. Sync from `auth.users` only
2. Create profiles table with trigger
3. Use alternative user table

## Auto-discovered Metrics

When syncing, look for these patterns in Supabase tables:

**From profiles/users:**
- `full_name`, `avatar_url`
- `tier`, `plan`, `role`
- `onboarding_completed`

**From subscriptions:**
- `status` (active/canceled/past_due)
- `plan_id`, `price_id`
- `current_period_end`

**From activity tables:**
- Count of posts/content
- Count of actions/events
- Last activity timestamp

**SQL to find metric candidates:**
```sql
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_schema = 'public'
  AND column_name LIKE '%count%'
   OR column_name LIKE '%total%'
   OR column_name LIKE '%_at'
   OR column_name IN ('tier', 'plan', 'status', 'role');
```
